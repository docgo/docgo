<style>
#searchForm { position: relative; }
#autocomplete { position: absolute; left: 0; right: 0; top: 40px; background: #fff; color: #61677C; border-radius: 10px; padding: 0 10px;}
#autocomplete label:first-child { margin-top: 10px; }
#autocomplete label:last-child { margin-bottom: 10px; }
#autocomplete label { display: block; padding: 6px 10px; }
#autocomplete label:hover { background: #eee; }
</style>
<script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.js"></script>
<script src="https://unpkg.com/uhtml"></script>
<script>
    const goIndex = {{ . }};

    var objList = Object.entries(goIndex).map(x => ({key: x[0], text: x[1].replace(/(<([^>]+)>)/gi, "") }))
    const fuseOpts = {
        includeScore: true,
        keys: ['text'],
        includeMatches: true,
        threshold: 0.3,
        ignoreLocation: true,
    }
    const fuse = new Fuse(objList, fuseOpts)
    const { render, html } = uhtml;
    searchField.addEventListener("blur", () => {
        setTimeout(() => render(autocomplete, html``), 250)
    })
    searchField.addEventListener("input", (e) => {
        const query = e.target.value.toLowerCase();
        const queryWords = query.split(/\s+/)
        const outList = fuse.search(e.target.value).map(result => {
            let words = result.item.text.split(/\s+/)
            var idx = -1
            queryWords.map(w => {
              if(words.findIndex(x => x.toLowerCase() === w.toLowerCase()) != -1) {
                  idx = words.findIndex(w)
              }
            })
            if(idx == -1) {
                var match = new Fuse(words, {threshold: 0.5}).search(e.target.value);
                idx = words.indexOf(match[0].item);
            }
            var clamp = (n, low, high) => n > high ? high : n < low ? low : n;
            var fromIdx = clamp(idx - 8, 0, idx - 1);
            var toIdx = clamp(idx + 8, idx + 1, words.length);
            var outw = [];
            for(var i = fromIdx; i < toIdx; i++) {
                if(i == idx)
                    outw.push(html`<strong>${words[i]} </strong>`)
                else
                outw.push(html`<span>${words[i]} </span>`)
            }
            return html`<label>${outw}</label>`
        })
        render(autocomplete, html` ${outList}`);
    })
</script>